[
    {
        "id": "93f871ed2d750c6f",
        "type": "tab",
        "label": "Self-Registration",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5c92197450990fc8",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "sudo openssl ecparam -name prime256v1 -genkey -noout -out /etc/mosquitto/certs/sunny-private-key.pem ",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Create Sunny Private Key ",
        "x": 490,
        "y": 280,
        "wires": [
            [
                "99a72d8a242e69b3"
            ],
            [],
            []
        ],
        "info": "EXEC"
    },
    {
        "id": "41c2f5610020f9a5",
        "type": "comment",
        "z": "93f871ed2d750c6f",
        "name": "Create MQTT Central Broker public/private key and MQTTS config files then instert keys into database",
        "info": "",
        "x": 530,
        "y": 120,
        "wires": []
    },
    {
        "id": "99a72d8a242e69b3",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": " sudo openssl ec -in  /etc/mosquitto/certs/sunny-private-key.pem -pubout -out /etc/mosquitto/certs/sunny-public-key.pem",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Create Sunny Public Key ",
        "x": 490,
        "y": 200,
        "wires": [
            [
                "01768021ba8ceedf"
            ],
            [],
            []
        ]
    },
    {
        "id": "01768021ba8ceedf",
        "type": "function",
        "z": "93f871ed2d750c6f",
        "name": "Sunny Deviice Profile table data prepartion",
        "func": "const fs = global.get('fs');\nconst os = global.get('os');\nconst crypto = global.get(\"crypto\");\nconst jwt = global.get(\"jwt\");\n\n// Key paths\nconst publicKeyPath = \"/etc/mosquitto/certs/sunny-public-key.pem\";\nconst privateKeyPath = \"/etc/mosquitto/certs/sunny-private-key.pem\";\n\n// --- Step 1: Read keys and store in global context ---\nconst publicKey = fs.readFileSync(publicKeyPath, 'utf8').trim();\nconst privateKey = fs.readFileSync(privateKeyPath, 'utf8').trim();\nglobal.set(\"public_key\", publicKey, \"file\");\nglobal.set(\"private_key\", privateKey, \"file\");\n\n// --- Step 2: Get MAC Addresses from wlan*/wlx* only ---\nconst networkInterfaces = os.networkInterfaces();\nlet macAddresses = [];\n\nfor (let iface in networkInterfaces) {\n    if (iface.startsWith('wlan') || iface.startsWith('wlx')) {\n        networkInterfaces[iface].forEach((detail) => {\n            if (detail.mac && !macAddresses.includes(detail.mac)) {\n                macAddresses.push(detail.mac);\n                node.log(`ðŸŸ¢ MAC Address Found on ${iface}: ${detail.mac}`);\n            }\n        });\n    }\n}\n\nlet macAddress1 = macAddresses[0] || \"00:00:00:00:00:00\";\nlet macAddress2 = macAddresses[1] || \"00:00:00:00:00:00\";\n\n// --- Step 3: Generate Device ID and timestamps ---\nlet deviceId = crypto.createHash('sha256').update(macAddress1 + macAddress2).digest('hex');\nlet registrationTime = Math.floor(Date.now() / 1000);\n\n// --- Step 4: Determine is_broker ---\nlet isBroker = macAddress2 !== \"00:00:00:00:00:00\" ? 1 : 0;\nlet devicename = \"sunny\";\nflow.set('devicename', devicename);\n// --- Step 5: Store device_id to global context ---\nglobal.set(\"device_id\", deviceId, \"file\");\n\n// --- Step 6: Create JWT payload and sign ---\nlet jwtPayload = {\n    device_id: deviceId,\n    device_name: devicename,\n    mac_address_1: macAddress1,\n    mac_address_2: macAddress2,\n    iat: registrationTime,\n    exp: registrationTime + 900,   // <<< 15 minutes\n    is_broker: isBroker\n};\n\nlet jwtToken = jwt.sign(jwtPayload, privateKey, { algorithm: 'ES256' });\n\n// --- Step 7: Prepare SQLCipher INSERT statement ---\nconst dbPath = \"/etc/mosquitto/certs/update_database.db\";\nconst pragmaKey = env.get(\"DB_PASSWORD\");\n\nconst sqlInsert = `PRAGMA key = '${pragmaKey}'; \nINSERT OR REPLACE INTO DeviceProfile (device_id, device_name, mac_address_1, mac_address_2, jwt_token, is_broker, authentication_status, registered_at) \nVALUES ('${deviceId}', '${devicename}', '${macAddress1}', '${macAddress2}', '${jwtToken}', ${isBroker}, NULL, ${registrationTime});`;\n\nmsg.payload = `sqlcipher ${dbPath} <<< \"${sqlInsert.trim()}\"`;\n\n// --- Step 8: Prepare MQTT Payload (matches DeviceProfile table) ---\nmsg.mqtt_payload = {\n    device_id: deviceId,\n    device_name: devicename,\n    mac_address_1: macAddress1,\n    mac_address_2: macAddress2,\n    is_broker: isBroker,\n    authentication_status: null,\n    registered_at: registrationTime\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 200,
        "wires": [
            [
                "42ddb68b155711a7",
                "912e0d8f4cfd25fc"
            ]
        ]
    },
    {
        "id": "42ddb68b155711a7",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Insert Data into Device Profile Table",
        "x": 1180,
        "y": 200,
        "wires": [
            [
                "eb7aafe5fffbf1d9"
            ],
            [],
            []
        ]
    },
    {
        "id": "eb7aafe5fffbf1d9",
        "type": "function",
        "z": "93f871ed2d750c6f",
        "name": "Sunny Keys table data prepartion",
        "func": "let deviceID;\nlet privateKey;\nlet publicKey;\nlet attempts = 0;\n\n// --- Step 1: Retry retrieval from global context (file scope) ---\nwhile ((!deviceID || !privateKey || !publicKey) && attempts < 5) {\n    if (!deviceID) deviceID = global.get(\"device_id\", \"file\");\n    if (!privateKey) privateKey = global.get(\"private_key\", \"file\");\n    if (!publicKey) publicKey = global.get(\"public_key\", \"file\");\n\n    if (!deviceID || !privateKey || !publicKey) {\n        node.warn(\"Retrying retrieval of key data from global context...\");\n        attempts++;\n        const waitUntil = Date.now() + 200;\n        while (Date.now() < waitUntil); // busy-wait 200ms\n    }\n}\n\n// --- Step 2: Handle missing data after retries ---\nif (!deviceID || !publicKey || !privateKey) {\n    node.error(\"âŒ deviceID, publicKey, or privateKey not found in global context!\");\n    return null;\n}\n\n// --- Step 3: Prepare SQL INSERT for Keys table (include registration_key as NULL) ---\nconst dbPath = \"/etc/mosquitto/certs/update_database.db\";\nconst pragmaKey = env.get(\"DB_PASSWORD\");\n\nconst sqlInsert = `\nPRAGMA key = '${pragmaKey}';\nINSERT OR REPLACE INTO Keys (device_id, private_key, public_key, registration_key)\nVALUES ('${deviceID}', '${privateKey}', '${publicKey}', NULL);\n`;\n\nmsg.payload = `sqlcipher ${dbPath} <<< \"${sqlInsert.trim()}\"`;\nconst devicename = flow.get('devicename');\n// --- Step 4: Prepare MQTT Payload (exclude private and registration key) ---\nmsg.mqtt_payload = {\n    device_id: deviceID,\n    devicename: devicename,\n    public_key: publicKey\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 220,
        "wires": [
            [
                "f949e1e0ad5812a8",
                "3199e675014515a9"
            ]
        ]
    },
    {
        "id": "f949e1e0ad5812a8",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Instert Data into Keys Table",
        "x": 1860,
        "y": 160,
        "wires": [
            [
                "ecc063b59cca37da"
            ],
            [],
            []
        ]
    },
    {
        "id": "780b3f9b8352c5ba",
        "type": "mqtt out",
        "z": "93f871ed2d750c6f",
        "name": "Sync Device Profile Table Data",
        "topic": "sync/data/device_profile",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "47b12596f39b9eb8",
        "x": 870,
        "y": 400,
        "wires": []
    },
    {
        "id": "3256555daf4236f9",
        "type": "mqtt out",
        "z": "93f871ed2d750c6f",
        "name": "Sync Keys Table Data",
        "topic": "sync/data/keys_",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "47b12596f39b9eb8",
        "x": 1540,
        "y": 80,
        "wires": []
    },
    {
        "id": "912e0d8f4cfd25fc",
        "type": "change",
        "z": "93f871ed2d750c6f",
        "name": "Set MQTTTS Payload for Data Sync",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.mqtt_payload",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 280,
        "wires": [
            [
                "780b3f9b8352c5ba"
            ]
        ]
    },
    {
        "id": "3199e675014515a9",
        "type": "change",
        "z": "93f871ed2d750c6f",
        "name": "Set MQTTTS Payload for Data Sync",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.mqtt_payload",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1530,
        "y": 160,
        "wires": [
            [
                "3256555daf4236f9"
            ]
        ]
    },
    {
        "id": "a09ea7e6549252aa",
        "type": "comment",
        "z": "93f871ed2d750c6f",
        "name": " MQTT Central Broker (Sunny)",
        "info": "",
        "x": 300,
        "y": 60,
        "wires": []
    },
    {
        "id": "bc0f285a9d69db6c",
        "type": "inject",
        "z": "93f871ed2d750c6f",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 220,
        "wires": [
            [
                "5c92197450990fc8"
            ]
        ]
    },
    {
        "id": "ecc063b59cca37da",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "step certificate fingerprint /home/step/.step/certs/root_ca.crt",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Check CA certificate finger print",
        "x": 1890,
        "y": 260,
        "wires": [
            [
                "3c98980c475bfe91"
            ],
            [],
            []
        ]
    },
    {
        "id": "3c98980c475bfe91",
        "type": "function",
        "z": "93f871ed2d750c6f",
        "name": "Prepare bootstrap to trust CA",
        "func": "const caUrl = \"https://192.168.151.1:8443\";\nconst fp    = msg.payload;\n\nif (!caUrl || !fp) {\n  node.error('Missing ca_url or fingerprint in global(file) context');\n  return null;\n}\n\n// One single line, no line breaks:\nmsg.payload = `step ca bootstrap --ca-url \"${caUrl}\" --fingerprint \"${fp}\" --install --force`;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2180,
        "y": 240,
        "wires": [
            [
                "1ef52524dcaa602a"
            ]
        ]
    },
    {
        "id": "5ea9260b0cdc4745",
        "type": "function",
        "z": "93f871ed2d750c6f",
        "name": "Prepare to create MQTTS key and certificate",
        "func": "// --- Step 1: File paths ---\nconst certPath = '/etc/mosquitto/certs/sunny.pem';\nconst keyPath = '/etc/mosquitto/certs/sunny-key.pem';\nconst provPassFile = '/etc/step-ca/secrets/provisioner_password';\n\n// --- Step 2: Prepare step-ca command for Exec node ---\nmsg.payload = `step ca certificate sunny \\\n${certPath} \\\n${keyPath} \\\n--san sunny \\\n--san 192.168.151.1 \\\n--provisioner \"Admin JWK\" \\\n--provisioner-password-file ${provPassFile} \\\n--force`;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2510,
        "y": 160,
        "wires": [
            [
                "724093b76af04bf4"
            ]
        ]
    },
    {
        "id": "724093b76af04bf4",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Create MQTTS key and cerificate",
        "x": 2560,
        "y": 240,
        "wires": [
            [
                "aeb6e7c4703ca4d8"
            ],
            [],
            []
        ]
    },
    {
        "id": "1ef52524dcaa602a",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Trust CA",
        "x": 2220,
        "y": 380,
        "wires": [
            [
                "5ea9260b0cdc4745"
            ],
            [],
            []
        ]
    },
    {
        "id": "aeb6e7c4703ca4d8",
        "type": "exec",
        "z": "93f871ed2d750c6f",
        "command": "sudo systemctl restart mosquitto-cert-renew.service | sudo systemctl kill -s HUP mosquitto",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Restart renew service",
        "x": 2840,
        "y": 200,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "47b12596f39b9eb8",
        "type": "mqtt-broker",
        "name": "",
        "broker": "192.168.151.1",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    }
]
